FROM debian:bookworm-slim as MAMBA

ENV PKG="curl git bzip2"

RUN apt-get -qq update \
    && apt-get -qq install $PKG \
    && apt-get -qq autoremove --purge && apt-get clean

RUN \
    case $(arch) in \
        aarch64) _ARCH="linux-aarch64" ;; \
        ppc64le) _ARCH="linux-ppc64le" ;; \
        *) _ARCH="linux-64" ;; \
    esac && \
    MICRO_MAMBA="https://micro.mamba.pm/api/micromamba/${_ARCH}/latest" && \
    curl -fsSL "$MICRO_MAMBA" | tar -xvj bin/micromamba && \
    mv bin/micromamba /usr/bin/mamba

FROM debian:bookworm-slim
ENV MAMBA_ROOT_PREFIX="/opt/dev"

COPY --from=MAMBA /usr/bin/mamba /usr/bin/mamba

RUN mamba install -y -n base -c conda-forge \
        python=3.12 \
        gradio fastapi hypercorn && \
    mamba clean --all --yes
